apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: login-argocd
spec:
  description: >-
    This task is for login into the staging cluster argocd environment 
  params:
    - name: ARGOCD_SERVER
      type: string
      description: The secret name where you have stored the staging argocd server details `argocd_server`
      default: argocd-server
  # results:
  #   - name: argocd-config
  workspaces:
    - name: output
  steps:
    - name: argocd-staging-login
      image: quay.io/devtools_gitops/test_image:4.0.5
      workingDir: /workspace/output
      script: |
        #!/usr/bin/env sh
        set -u -o pipefail

        echo "Login into argocd"
        argocd login --insecure ${URL} --password ${PASSWORD} --username ${USERNAME} --config "$(pwd)/argocdconfig" --grpc-web
      env:
        - name: PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ARGOCD_SERVER)
              key: argocd_server_password
        - name: USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ARGOCD_SERVER)
              key: argocd_server_username
        - name: URL
          valueFrom:
            secretKeyRef:
              name: $(params.ARGOCD_SERVER)
              key: argocd_server_url
