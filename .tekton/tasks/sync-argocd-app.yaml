apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: app-sync
spec:
  description: >-
    This task is for syncing the staging cluster argocd application
  params:
    - name: pull_request_files
      type: string
      description: Files changed in the pull request which has been merged to be deployed on RHTAP staging environment
      default: ""
  results:
    - name: app-name
      description: Name of the app to be synced
  workspaces:
   - name: argocd-config
  steps:
    - name: argocd-app-sync
      image: quay.io/devtools_gitops/test_image:4.0.5
      workingDir: $(workspaces.argocd-config.path)
      env:
        - name: PULL_REQUEST_FILES
          value: $(params.pull_request_files)
      script: |
        #!/usr/bin/env sh
        set -u -o pipefail

        chmod 0400 "$(pwd)/argocdconfig"
        declare app_name=
        for i in $(argocd app list --config "$(pwd)/argocdconfig" -o json | jq -r '.[] | .metadata.name'); do
          app_name=$(echo "$PULL_REQUEST_FILES" | grep -o "\b$i\b" | uniq)
          if [ "$app_name" != "" ]; then
            echo "trigger the deployment for $app_name"
            argocd app sync $app_name --config "$(pwd)/argocdconfig"
            echo $app_name | tee $(results.app-name.path)
            break
          fi
        done

        if [ -z $app_name ]; then
          echo "application not deployed yet in the argocd"
        fi
