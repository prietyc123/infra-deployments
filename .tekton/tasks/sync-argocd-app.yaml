apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: app-sync
spec:
  description: >-
    This task is for syncing the staging cluster argocd application
  params:
    - name: pull_request_title
      type: string
      description: Title of the pull request which has been merged to be deployed on RHTAP staging environment
      default: ""
  results:
    - name: app-name
      description: Name of the app to be synced
  workspaces:
   - name: argocd-config
  steps:
    - name: argocd-app-sync
      image: quay.io/devtools_gitops/test_image:4.0.5
      workingDir: $(workspaces.argocd-config.path)
      env:
        - name: PULL_REQUEST_TITLE
          value: $(params.pull_request_title)
      script: |
        #!/usr/bin/env sh
        set -u -o pipefail

        chmod 0400 "$(pwd)/argocdconfig"
        declare app_name=
        for i in $(argocd app list --config "$(pwd)/argocdconfig"); do
          app_name=$(echo $PULL_REQUEST_TITLE | grep -o "\b$i\b")
          if [ -n $app_name ]; then
            echo "trigger the deployment for $app_name"
            argocd app sync $app_name --config "$(pwd)/argocdconfig"
            echo $app_name | tee $(results.app-name.path)
            break
          fi
        done

        if [ -z $app_name ]; then
          echo "app: $PULL_REQUEST_TITLE not found in the argocd"
        fi
