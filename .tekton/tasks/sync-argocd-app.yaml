apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: app-sync
spec:
  description: >-
    This task is for syncing the staging cluster argocd application
  params:
    - name: pull_request_title
      type: string
      description: Title of the pull request which has been merged to be deployed on RHTAP staging environment
      default: ""
  workspaces:
    - name: infra-deployment-git
  steps:
    - name: argocd-app-sync
      image: quay.io/devtools_gitops/test_image:4.0.5
      workingDir: $(workspaces.infra-deployment-git.path)
      script: |
        #!/usr/bin/env python3
        import subprocess

        cmd = "pip3 install pyyaml"
        output = subprocess.Popen(cmd.split(), stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = output.communicate()

        # Load param config versions
        with open('argocd-staging-app.yaml') as f:
          import yaml
          app = yaml.safe_load(f)
        
        # Function to check if the element is present in pull-request-title
        def contains_app(element):
            return element in $(params.pull_request_title)

        # Find the matching application
        matched_app_name = next((element for element in app if contains_app(element)), None)

        if matched_app_name:
          app_name = ', '.join(matched_app_name)
          echo "trigger the deployment"
          argocd app sync app_name
        else:
          print("Either the app has not been added to staging yet or argocd-staging-app.yaml file does not have information of the app")

